ログイン出来るようにする
========================

[ユーザーからの入力を受けられるようになった](../2_receive-data/)ので、今度はそれを発展させてログイン・ログアウトを実装してみます。

このステップでも[プログラムのサンプル](./app.py)を用意してありますので、必要であれば参考にしてください。

## 何が必要か
ログインという動作を分解して考えてみると、以下のようなものになるかと思います。

1. ユーザーから名前とパスワードを受け取る
2. ユーザー名とパスワードが正しいか調べる
3. この人は誰だ、という情報を記憶する
4. 記憶した情報を元にサービスを提供する

ログアウトはこれに比べれば簡単で、ログインしたという記録を消せば実現出来ます。

1のユーザー名とパスワードを受け取る方法については、[前のステップ](../2_receive-data/)の方法をそのまま利用出来ます。

2の検証ですが、問題を簡単にするために、今回は無条件にログイン成功と見做すことにします。
こちらも前のステップと同じ方法で作れますので、試してみてください。

3と4の処理は、ユーザー名とパスワードを何度も入力しなくて済むようにするためのものです。
ログインしたことを記録するために、[Cookie](https://ja.wikipedia.org/wiki/HTTP_cookie)という仕組みを使います。

**Cookie**は簡単に盗聴が可能なので、本来は機密性の高い情報を保存する目的で使ってはいけません。
しかし、[Flask](http://flask.pocoo.org/)には**Cookie**を安全に扱うための方法がありますので、これを利用することにします。

## ユーザー名とパスワードを受け取る
まず最初に、ユーザーの名前とパスワードを受け取る機能を実装します。

``` python
@app.route('/')
def index():
    return '''
    <form action="/login">
        ユーザー名: <input name="name"><br>
        パスワード: <input name="password" type="password"><br>
        <input type="submit" value="ログイン"><br>
    </form>
    '''


@app.route('/login')
def login():
    name = flask.request.args.get('name')

    return 'ようこそ ' + name + 'さん'
```
パスワードを入力する欄も作りましたが、このステップでは使いません。
[前のステップ](../2_receive-data/)を参考に、パスワードをチェックする方法を考えてみてください。

この時点では、ログインしたらしい動きはしますが、保存されないのでそれらしいだけのものです。

## Cookieを使う前準備
ユーザー名をそのまま保存すると、盗聴されて悪用される恐れがあります。
ですので、ユーザー名は暗号化した上でCookieに保存します。
といっても、このあたりはFlaskがやってくれるのであまり気にする必要はありません。

この機能を使うために、最初に暗号化に使うパスワードをFlaskに設定します。
設定はプログラムの最初の方を以下のように書き換えることで行ないます。
``` python
import flask


app = flask.Flask(__name__)
app.config['SECRET_KEY'] = 'this is secret password'
```

`'this is secret password'`の部分はユーザーの安全を守るためのパスワードですので、ランダムな値にして、決して人に教えないようにしてください。

## ログインする
準備が出来たら、いよいよログイン機能を実装します。

`login`関数を以下のように書き換えてください。
``` python
@app.route('/login')
def login():
    flask.session['name'] = flask.request.args.get('name')

    return 'ようこそ ' + flask.session['name'] + 'さん<br><a href="/mypage">マイページへ</a>'
```
`flask.session`のあとの括弧が、普通の丸括弧（`()`）ではなく四角い括弧（`[]`）であることに注意してください。

さらに、新しくページを追加します。
``` python
@app.route('/mypage')
def mypage():
    return flask.session['name'] + 'さんのページ'
```

### 試してみる
プログラムを書けたら、実行して試してみてください。
[http://localhost:5000/](http://localhost:5000/)にアクセスすると、ユーザー名とパスワードを入力する画面が表示されます。
適当に入力して**ログイン**ボタンを押すと、ようこそという表示が出ます。

ここまでの動作は、[前のステップ](../2_receive-data/)と同じものです。
次に、**マイページへ**というリンクをクリックしてみてください。

今度は入力したわけではないのにユーザー名が表示されるはずです。
これで、ログインが実現出来ました。

### 何が起こったのか
`login`関数を見てみると、[Cookieを使わずに作ったもの](#ユーザー名とパスワードを受け取る)と見比べると、ほとんど何も変わっていないことが分かるかと思います。
`mypage`関数も同じ方法でCookieから値を読み出しています。

Flaskで値をCookieに保存する時は、`flask.session`というものの中に入れます。
`flask.session['名前']`のようにして、`flask.session`の中身を読み書きします。
この`名前`の部分は変数名と同じように自由に変更出来ます。今回はユーザー名を保存するので`name`という名前にしましたが、目的に応じて分かりやすい名前を使ってください。

`flask.request.args`では駄目なのかと思われるかもしれませんが、残念ながらそれは出来ません。
マイページにアクセスしたときのアドレスを見てみると、[http://localhost:5000/mypage](http://localhost:5000/mypage)のようになっているはずです。
このアドレスには*query*が無いので、`flask.request.args`では取得することが出来ないのです。
（この意味がよく分からなければ、[前のステップの解説](../2_receive-data/#試してみる)を読んでください）

## ログアウトする
ログインが出来たので、今度はログアウト出来るようにします。

ログアウトは保存したユーザー名を消すことで実現します。
Cookieに保存した値を削除するには、以下のようにします。
``` python
del flask.session['名前']
```

これをユーザーが使えるように、ログアウトページを作ります。
以下のような関数を追加してください。
``` python
@app.route('/logout')
def logout():
    del flask.session['name']

    return 'ログアウトしました<br><a href="/">トップページへ戻る</a>'
```

### 試してみない
これで、[http://localhost:5000/logout](http://localhost:5000/logout)にアクセスすればログアウト出来るようになりました。
しかし残念ながら、ログイン出来ているかどうかチェックする方法がまだありません。なので、今はまだ試すことが出来ません。

マイページにアクセスすればと思われるかもしれませんが、先程作ったプログラムはユーザーがログインしていない可能性を考慮していませんでした。
ログインしていないのにマイページにアクセスすると、プログラムが停止してしまいます。（厳密には停止しませんが、状況はあまり変わりません）

少々強引ですが、エラーが起きるかどうかでログアウト出来ているかどうかの確認が出来ますので、試してみるのも良いかもしれません。

## ログイン済みかどうかのチェック
毎回エラーが起きては困るので、まだログインしていない場合は「ログインしてください」と表示するようにします。
ログインしているかどうか、というのは、ユーザー名がCookieに保存されているか、というチェックを行なえば実現出来ます。

`mypage`関数を以下のように書き換えてください。
``` python
@app.route('/mypage')
def mypage():
    if 'name' in flask.session:
        return flask.session['name'] + 'さんのページ<br><br><a href="/logout">ログアウト</a> <a href="/">トップページ</a>'
    else:
        return 'ログインしてください<br><br><a href="/">トップページ</a>'
```

### 試してみる
これでログアウトしたことが分かるようになりました。実行して試してみてください。

[マイページ](http://localhost:5000/mypage)にアクセスすると、ログインしていればユーザー名が、していなければ「ログインしてください」と表示されるはずです。
ログインしたりログアウトしたりして、挙動を確かめてみてください。

### 何が起こったのか
`'name' in flask.session`という一文で、`name`という名前のデータが`flask.session`に保存されているかどうかチェックしています。
英語の`in`と殆ど同じ意味で、「flask.sessionの中に'name'というものがあるか」という意味と捉えてください。

それ以外は、[前のステップでやったこと](../2_receive-data/#入力に応じて動きを変えてみる)と殆ど同じです。

## ざっくりとしたまとめ
`flask.session`を使うと、クライアントにデータを保存しておいてもらうことが出来ます。
このデータを保存しておいてもらう場所のことを*Cookie*と言います。

Cookieへの値は、以下のようにします。
``` python
flask.session['名前'] = 値
```

Cookieの値を削除するには、以下のようにします。
``` python
del flask.session['名前']
```

Cookieに値が保存されているかどうかの確認は、`'名前' in flask.session`のようにして行ないます。
if文と組合せて使うと、以下のようになります。
``` python
if '名前' in flask.session:
    値が保存されていたときの処理
else:
    値が保存されていなかったときの処理
```

## 次になにをすれば良いか
Cookieはユーザー名だけでなく、色々なものを保存することが出来ます。
これを使えば、メモ帳やToDoリストなど、色々なものを作ることが出来ます。
思い付いたものを作って、試してみてください。

ただし、Cookieに保存される値は一時的なものであることに注意してください。
また、Cookieの値は他のクライアントから見ることが出来ません。
ですので、長期間安全にデータを保存したい場合や、他のユーザーにも見せたい値を保存するときは[他の方法](../6_database/)を使うようにしてください。

[次のステップ](../4_discussion-board/)では、サーバー側にデータを保存して掲示板のようなものを作ります。
