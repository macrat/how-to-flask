データを受信する
================

[Hello Worldと表示されるだけのアプリ](./1_hello-world/)ではつまらないので、クライアント（ブラウザのことです）からの入力を受け取って、それを表示するものを作ってみます。

なお、ここで**クライアント**と呼んで居るのはユーザーが使用しているブラウザのことです。
そのブラウザを利用している利用者のことは、ユーザーと呼びます。大くの場合、クライアントとユーザーは区別されるので注意してください。

必要であれば、このステップで作成する[プログラムのサンプル](./app.py)も参考にしてください。全く同じものではありませんが、ほとんど同じように出来ています。

## 何が必要か
ユーザーに何かを入力してもらって、それを受信するためには大きくわけて二つのものが必要になります。
入力を促すページと、それを受け取るページです。
[Flask](http://flask.pocoo.org/)では、そのまま関数を二つ用意すれば実現出来ます。
同じページで、つまり同じ関数でこれを行なうことも出来ますが、ひとまずこれについては考えないことにします。

## 入力を促すページ
まずは、ユーザーに入力を促すためのページを作成していきます。
といっても、このページはいつも同じ表示をするだけなので、[Hello World](./1_hello-world/)と殆ど同じプログラムで作ることが出来ます。

必要な関数は以下のようになります。
``` python
@app.route('/')
def index():
    return '''
    <form action="/receive">
        <input name="value">
        <input type="submit">
    </form>
    '''
```

[Hello World](./1_hello-world/)のときと違い、文章を囲む記号に`'''`を使用していることに注意してください。
シングルクォートが一つだけの文字列には改行を含めることが出来ませんが、三つ重ねたものであれば改行を含めることが出来るようになります。

`index`関数が返却する文字列は、HTML文になっています。
内容はとてもシンプルで、入力を受け取るための`form`が一つと、その中に入力欄と送信ボタンが一つずつあるだけのものです。

### 試してみる
ここまで実装が出来たら、ファイルに保存してコンソールから実行してみてください。（実行の仕方は[前のステップ](../1_hello-world/#実行し、試してみる)を参照してください。）
ブラウザでアクセスしてみると、入力欄が一つと**送信**というボタンが一つ表示されるはずです。
適当な文章を入力して**送信**をクリックすると、`http://localhost:5000/receive?value=hoge`のようなアドレスに転送されます。（現時点ではページが見付からない旨を示すエラーが表示されるはずです。）

`/receive`の部分は`form`タグの`action="/receive"`という部分で、`value`という部分は`input`タグの`name="value"`という部分でそれぞれ指定したものです。
また、`hoge`の部分はあなたが入力欄に入力したもので置き換わっているはずです。

`input`タグは必要に応じて[色々な種類](http://www.htmq.com/html5/input.shtml)や自由な数を記述出来ます。それぞれを区別しやすいように、`name`要素には分かりやすい名前を付けるようにしましょう。

## 入力を受け取るページ
入力を受け取るには、`flask.request.args`という物を使います。
コードにすると、以下のようになります。
``` python
@app.route('/receive')
def receive():
    return '入力されたデータは"' + flask.request.args.get('value') + '"です'
```

`flask.request.args.get('value')`という部分で受信したデータを取得しています。
`'value'`の部分は、`input`タグに指定した`name`の値を指定します。もし`value`以外の値が欲しい場合、それに合せて書き換えてください。

取得したデータ（ここでは文字列です）と、`'入力されたデータは"'`などの文字列を結合していることに注意してください。
Pythonでは、文字列同士を足し算のように繋ぎ合せることが出来るのです。（実はこれはあまり良い書き方ではないのですが、簡単なのでひとまずこの方法を使います）

### 試してみる
ここまで実装が終わったら、もう一度実行して`http://localhost:5000/`にアクセスしてみてください。
先ほど確認したのと同じく、入力欄が一つと**送信**ボタンが一つ表示されるはずです。

ここで適当な文章を入力して**送信**をクリックすると、今度はエラーは表示されずに受信したメッセージが表示されるはずです。

## 入力に応じて動きを変えてみる
クライアントからの入力を受け取れることを確認出来たら、それに応じてWebアプリケーションの挙動を変えてみましょう。
ここでは、ユーザー名を入力して管理者ページとそれ以外のページで分けることを想定して作ってみます。

さきほどのプログラムの`receive`関数を以下のように書き換えてください。
``` python
@app.route('/receive')
def receive():
    name = flask.request.args.get('value')
    if name == 'admin':
        return 'this is admin page'
    else:
        return 'welcome ' + name
```

### 試してみる
プログラムの動作を細かく追う前に、ひとまず動作を見てみましょう。
実行し、ブラウザからアクセスしてみてください。

さきほどと同じ入力欄が表示されるので、適当な文章を入力して送信してみてください。
`welcome`という表示のあとに、あなたが入力した文章が表示されるはずです。

表示を確認出来たら、今度は`admin`という文章を入力して送信してみてください。
すると今度は、`welcome admin`ではなく`this is admin page`という表示がなされるはずです。
これで、管理者ページを実装出来ました。（もちろんこれは子供騙しです。当然ですが、実際はこんな脆弱な管理者ページを実装してはいけません。）

### なにが起こったのか
プログラムを見返して、何が起こったのかを調べてみます。

最初の2行は[先程のプログラム](./#入力を受け取るページ)と同じです。

3行目は先程と同じ方法でクライアントからの入力を取得しています。
先程と違うのは、そのままクライアントに返却するのではなく、`name`という変数に保存しています。

4行目で、ユーザーの入力が`admin`かどうかを調べています。これは、[if文](http://docs.python.jp/3/tutorial/controlflow.html#if-statements)と呼ばれるものです。
他のプログラムでは括弧で括って記述することが多いですが、Pythonではこのような形式になります。
5行目は、if文に指定した式が正しければ実行される部分です。
インデント（左側のスペース）が二段分深くなっていることに注意してください。`def`から始まる関数定義の分で一段目、`if`から始まる分岐の分で二段目です。

6行目、7行目では、条件に当て嵌らなかった場合の処理を記述しています。
5行目と同じく、7行目も二段分のインデントが成されていることに注意してください。

4行目から7行目の処理をまとめて日本語にすると、「もしも`name`が`admin`という言葉だったら、`this is admin page`という文章を返却する。そうでなければ、`welcome `という文章のあとに`name`の中身を繋げたものを返却する。」ということになります。

## 計算もしてみる
今度は、入力された値に応じた計算をしてみることにします。
簡単な計算で、足し算を実装してみましょう。

`receive`関数を以下のように書き換えてみてください。
``` python
@app.route('/receive')
def receive():
    number = flask.request.args.get('value')
    answer = int(number) + 1
    return str(answer)
```

### 試してみる
実装出来たら、試してみましょう。

入力欄に数字を入力して送信すると、その数字に1足された数字が表示されるはずです。

### なにが起こったのか
今回もまたプログラムを見返してみます。

今回新しくなったのは、4行目と5行目の部分です。
4行目では、[`int`という関数](http://docs.python.jp/3/library/functions.html#int)で文字列を[数値](http://docs.python.jp/3/library/stdtypes.html#typesnumeric)に変換してから1加算しています。ここの数字を増やしたり減らしたりすれば、加算する量を変更することが出来ます。

5行目では、新しく計算した数値を[`str`という関数](http://docs.python.jp/3/library/stdtypes.html#str)で文字列に変換して、`return`でクライアントに返却しています。

サンプルプログラムでは`+ 1`としましたが、たとえば`- 1`にすれば1減らすように、`* 2`では二倍に、`/ 2`では半分になります。
HTMLに複数の`input`タグを追加して、計算機のようなものを作ることも出来ます。試してみてください。

### すこし安全に
なお、ここで使用した`int`という関数に数値以外が含まれている文字列を渡すと、`ValueError`というエラーが発生します。
これを防ぐためには、ちゃんと数字かどうか確認してから変換するのが簡単です。（本当はPythonでは[*例外処理*](http://docs.python.jp/3/tutorial/errors.html)と呼ばれる方式が一般的なのですが、すこしややこしいのでここでは触れません。）

文字列に含まれる文字が全て数字かどうか確認するには、文字列に付いている`.isdigit()`というメソッド（値に紐付けられた関数のようなもの）が利用出来ます。
これを使って、すこし安全に実装したバージョンは以下のようになります。
``` python
@app.route('/receive')
def receive():
    number = flask.request.args.get('value')
    if number.isdigit():
        answer = int(number) + 1
        return str(answer)
    else:
        return '数字を入力してください。'
```

`number.isdigit()`とすることで、文字列`number`の中身が数字だけかどうか調べることが出来ます。
これを[先ほどのif文](./#入力に応じて動きを変えてみる)と組み合わせることで、入力が正しければ計算を、正しくなければエラーメッセージを表示するように切り替えています。

## ざっくりとしたまとめ
`flask.request.args.get()`を使うと、クライアントからのデータを受け取ることが出来ます。
ここで得られるデータは文字列なので、必要なら`int()`のような関数を使って数値に変換したりして使用します。

取得した値に応じて動作を変えるには、`if`文を使用します。
if文は以下のような形式で記述します。
``` python
if 条件:
    条件が正しかったときの処理
else:
    条件が正しくなかったときの処理
```

## 次になにをすれば良いか
ここまでで、条件に合せて動作を変えるプログラムらしいプログラムを書けるようになりました。
どんな風書けばどんな風に動くのか、色々と試してみることをお勧めします。

思う存分試したら、[次のステップ](../3_discussion-board/)でもう少し実用的なWebアプリケーションを作ってみましょう。
